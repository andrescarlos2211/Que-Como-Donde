<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="shortcut icon" href="#">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>Administrador</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css"
        integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.bundle.min.js"
        integrity="sha384-BOsAfwzjNJHrJ8cZidOg56tcQWfp6y72vEJ8xQ9w6Quywb24iOsW913URv1IS4GD"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap5.min.css">
    <style>
        table.dataTable thead {
            background-color: #7952b3;
            color: aliceblue;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <button id="btnCrear" class="btn btn-dark mt-2">Crear</button>
        <div class="row shadow-lg p-3 mb-5">
            <div class="col">
                <table id="tablaArticulos" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>publication_id</th>
                            <th>publication_name</th>
                            <th>publication_price</th>
                            <th>publication_description</th>
                            <th>keyword1</th>
                            <th>keyword2</th>
                            <th>publication_qty</th>
                            <th>comuna_id</th>
                            <th>region_id</th>
                            <th>user_id</th>
                            <th>imgdir</th>
                            <th class="text-center">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!--Modal para CRUD-->
    <div id="modalCRUD" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                </div>
                <form id="formArticulos">
                    <div class="modal-body">

                        <input id="publication_id" hidden>

                        <label for="" class="col-form-label">publication_name</label>
                        <input id="publication_name" type="text" class="form-control">

                        <label for="" class="col-form-label">publication_price</label>
                        <input id="publication_price" type="number" class="form-control">

                        <label for="" class="col-form-label">publication_description</label>
                        <input id="publication_description" type="text" class="form-control">

                        <label for="" class="col-form-label">keyword1</label>
                        <input id="keyword1" type="text" class="form-control">

                        <label for="" class="col-form-label">keyword2</label>
                        <input id="keyword2" type="text" class="form-control">

                        <label for="" class="col-form-label">publication_qty</label>
                        <input id="publication_qty" type="number" class="form-control">

                        <label for="" class="col-form-label">comuna_id</label>
                        <input id="comuna_id" type="number" class="form-control">

                        <label for="" class="col-form-label">region_id</label>
                        <input id="region_id" type="number" class="form-control">

                        <label for="" class="col-form-label">user_id</label>
                        <input id="user_id" type="number" class="form-control">

                        <label for="" class="col-form-label">imgdir</label>
                        <input id="imgdir" type="text" class="form-control">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnGuardar" class="btn btn-dark">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.min.js"
        integrity="sha384-5h4UG+6GOuV9qXh6HqOLwZMY4mnLPraeTrjT5v07o347pj6IkfuoASuGBhfDsp3d"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.all.min.js"></script>
    <script type="text/javascript" language="javascript"
        src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript"
        src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function () {
            let url = 'http://localhost:4000/api/v1/publicaciones';
            let opcion = null;
            let publication_id,
                publication_name,
                publication_price,
                publication_description,
                keyword1,
                keyword2,
                publication_qty,
                comuna_id,
                region_id,
                user_id,
                imgdir;
            //MOSTRAR
            let tablaArticulos = $('#tablaArticulos').DataTable({
                "ajax": {
                    "url": url,
                    "dataSrc": ""
                },
                "columns": [
                    { "data": "publication_id" },
                    { "data": "publication_name" },
                    { "data": "publication_price" },
                    { "data": "publication_description" },
                    { "data": "keyword1" },
                    { "data": "keyword2" },
                    { "data": "publication_qty" },
                    { "data": "comuna_id" },
                    { "data": "region_id" },      
                    { "data": "user_id" },
                    { "data": "imgdir" },
                    
                    { "defaultContent": "<div class='text-center'><div class='btn-group'><button class='btn btn-info btn-sm btnEditar'>Editar</button><button class='btn btn-danger btn-sm btnBorrar'>Borrar</button></div></div>" }
                ]
            });
            //CREAR
            $("#btnCrear").click(function () {
                opcion = 'crear';
                id = null;
                $("#formArticulos").trigger("reset");
                $(".modal-header").css("background-color", "#23272b");
                $(".modal-header").css("color", "white");
                $(".modal-title").text("Crear Artículo");
                $('#modalCRUD').modal('show');
            });
            //EDITAR        
            $(document).on("click", ".btnEditar", function () {
                opcion = 'editar';
                fila = $(this).closest("tr");
                publication_id = parseInt(fila.find('td:eq(0)').text());
                publication_name = fila.find('td:eq(1)').text();
                publication_price = fila.find('td:eq(2)').text();
                publication_description = fila.find('td:eq(3)').text();
                keyword1 = fila.find('td:eq(4)').text();
                keyword2 = fila.find('td:eq(5)').text();                
                publication_qty = fila.find('td:eq(6)').text();
                comuna_id = fila.find('td:eq(7)').text();
                region_id = fila.find('td:eq(8)').text();
                user_id = fila.find('td:eq(9)').text();
                imgdir = fila.find('td:eq(10)').text();

                $("#publication_id").val(publication_id);
                $("#publication_name").val(publication_name);
                $("#publication_price").val(publication_price);
                $("#publication_description").val(publication_description);
                $("#keyword1").val(keyword1);
                $("#keyword2").val(keyword2);
                $("#publication_qty").val(publication_qty);
                $("#comuna_id").val(comuna_id);
                $("#region_id").val(region_id);
                $("#user_id").val(user_id);
                $("#imgdir").val(imgdir);

                $(".modal-header").css("background-color", "#7303c0");
                $(".modal-header").css("color", "white");
                $(".modal-title").text("Editar Artículo");
                $('#modalCRUD').modal('show');
            });

            //BORRAR
            $(document).on("click", ".btnBorrar", function () {
                fila = $(this);
                id = parseInt($(this).closest('tr').find('td:eq(0)').text());
                Swal.fire({
                    title: '¿Confirma eliminar el registro?',
                    showCancelButton: true,
                    confirmButtonText: `Confirmar`,
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: url + '/' + id,
                            method: 'delete',
                            data: { id: id },
                            success: function () {
                                tablaArticulos.row(fila.parents('tr')).remove().draw();
                            }
                        });
                        Swal.fire('¡Registro Eliminado!', '', 'success')
                    }
                })
            });
            //submit para el CREAR y EDITAR
            $('#formArticulos').submit(function (e) {
                e.preventDefault();
                publication_id = $.trim($('#publication_id').val());
                publication_name = $.trim($('#publication_name').val());
                publication_price = $.trim($('#publication_price').val());
                publication_description = $.trim($('#publication_description').val());
                keyword1 = $.trim($('#keyword1').val());
                keyword2 = $.trim($('#keyword2').val());
                publication_qty = $.trim($('#publication_qty').val());
                comuna_id = $.trim($('#comuna_id').val());
                region_id = $.trim($('#region_id').val());
                user_id = $.trim($('#user_id').val());
                imgdir = $.trim($('#imgdir').val());





                if (opcion == 'crear') {
                    $.ajax({
                        url: url,
                        method: 'post',
                        contentType: 'application/json',
                        data: JSON.stringify({ publication_id: publication_id, publication_name: publication_name, publication_price: publication_price, publication_description: publication_description, keyword1: keyword1, keyword2: keyword2, publication_qty: publication_qty, comuna_id: comuna_id, region_id: region_id , user_id: user_id, imgdir: imgdir }),
                        success: function (data) {
                            tablaArticulos.ajax.reload(null, false);
                        }
                    });
                }
                if (opcion == 'editar') {
                    console.log("EDITAR");
                    $.ajax({
                        url: url + '/' + user_id,
                        method: 'put',
                        contentType: 'application/json',
                        data: JSON.stringify({ publication_id: publication_id, publication_name: publication_name, publication_price: publication_price, publication_description: publication_description, keyword1: keyword1, keyword2: keyword2, publication_qty: publication_qty, comuna_id: comuna_id, region_id: region_id ,user_id: user_id, imgdir: imgdir }),
                        success: function (data) {
                            tablaArticulos.ajax.reload(null, false);
                        }
                    });
                }
                $('#modalCRUD').modal('hide');
            });
        });
    </script>